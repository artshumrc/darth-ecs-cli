"""S3 bucket construct â€” one per environment per logical bucket."""

from __future__ import annotations

from aws_cdk import RemovalPolicy, aws_iam, aws_s3
from constructs import Construct


class AppS3Bucket(Construct):
    """Provisions an S3 bucket with optional CORS and public read."""

    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        *,
        project_name: str,
        env_name: str,
        bucket_name_suffix: str,
        public_read: bool = False,
        cors: bool = False,
    ) -> None:
        super().__init__(scope, construct_id)

        bucket_name = f"{project_name}-{env_name}-{bucket_name_suffix}"

        cors_rules = []
        if cors:
            cors_rules.append(
                aws_s3.CorsRule(
                    allowed_methods=[
                        aws_s3.HttpMethods.GET,
                        aws_s3.HttpMethods.PUT,
                        aws_s3.HttpMethods.POST,
                    ],
                    allowed_origins=["*"],
                    allowed_headers=["*"],
                    max_age=3600,
                )
            )

        self.bucket = aws_s3.Bucket(
            self,
            "Bucket",
            bucket_name=bucket_name,
            removal_policy=RemovalPolicy.RETAIN,
            auto_delete_objects=False,
            block_public_access=(
                aws_s3.BlockPublicAccess.BLOCK_ACLS
                if public_read
                else aws_s3.BlockPublicAccess.BLOCK_ALL
            ),
            cors=cors_rules if cors_rules else None,
        )

        if public_read:
            self.bucket.add_to_resource_policy(
                aws_iam.PolicyStatement(
                    actions=["s3:GetObject"],
                    resources=[f"{self.bucket.bucket_arn}/*"],
                    principals=[aws_iam.AnyPrincipal()],
                )
            )
