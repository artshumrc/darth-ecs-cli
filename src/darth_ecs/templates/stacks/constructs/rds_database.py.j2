"""RDS PostgreSQL database construct."""

from __future__ import annotations

from aws_cdk import (
    Duration,
    RemovalPolicy,
    aws_ec2,
    aws_rds,
    aws_secretsmanager,
)
from constructs import Construct


class RdsDatabase(Construct):
    """Provisions an RDS PostgreSQL instance, optionally from a snapshot."""

    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        *,
        vpc: aws_ec2.IVpc,
        project_name: str,
        env_name: str,
        database_name: str,
        instance_type_str: str = "t4g.micro",
        allocated_storage_gb: int = 20,
        engine_version: str = "15",
        backup_retention_days: int = 7,
        snapshot_identifier: str | None = None,
    ) -> None:
        super().__init__(scope, construct_id)

        prefix = f"{project_name}-{env_name}"

        # Security group â€” no outbound by default
        self.security_group = aws_ec2.SecurityGroup(
            self,
            "DbSg",
            vpc=vpc,
            description=f"{prefix} RDS",
            allow_all_outbound=False,
        )

        # Parse instance type
        parts = instance_type_str.split(".")
        instance_class = getattr(aws_ec2.InstanceClass, parts[0].upper().replace("T4G", "BURSTABLE4_GRAVITON").replace("T3", "BURSTABLE3").replace("M5", "STANDARD5").replace("M6G", "STANDARD6_GRAVITON").replace("R5", "MEMORY5").replace("R6G", "MEMORY6_GRAVITON"))
        instance_size = getattr(aws_ec2.InstanceSize, parts[1].upper())
        instance_type = aws_ec2.InstanceType.of(instance_class, instance_size)

        engine = aws_rds.DatabaseInstanceEngine.postgres(
            version=getattr(aws_rds.PostgresEngineVersion, f"VER_{engine_version}")
        )

        subnet_group = aws_rds.SubnetGroup(
            self,
            "SubnetGroup",
            vpc=vpc,
            description=f"{prefix} DB subnets",
            vpc_subnets=aws_ec2.SubnetSelection(
                subnet_type=aws_ec2.SubnetType.PRIVATE_WITH_EGRESS
            ),
        )

        common_props = dict(
            vpc=vpc,
            instance_type=instance_type,
            engine=engine,
            security_groups=[self.security_group],
            subnet_group=subnet_group,
            instance_identifier=f"{prefix}-db",
            removal_policy=RemovalPolicy.SNAPSHOT,
            deletion_protection=env_name == "prod",
            backup_retention=Duration.days(backup_retention_days),
            allocated_storage=allocated_storage_gb,
            storage_type=aws_rds.StorageType.GP3,
            multi_az=False,
        )

        if snapshot_identifier:
            self._db = aws_rds.DatabaseInstanceFromSnapshot(
                self,
                "Db",
                snapshot_identifier=snapshot_identifier,
                credentials=aws_rds.SnapshotCredentials.from_generated_secret(
                    username=database_name,
                    secret_name=f"{prefix}-db-credentials",
                ),
                **common_props,  # type: ignore[arg-type]
            )
        else:
            credentials = aws_rds.Credentials.from_generated_secret(
                username=database_name,
                secret_name=f"{prefix}-db-credentials",
            )
            self._db = aws_rds.DatabaseInstance(
                self,
                "Db",
                database_name=database_name,
                credentials=credentials,
                **common_props,  # type: ignore[arg-type]
            )

    @property
    def endpoint(self) -> str:
        return self._db.db_instance_endpoint_address

    @property
    def port(self) -> str:
        return self._db.db_instance_endpoint_port

    @property
    def credentials_secret_arn(self) -> str:
        secret = self._db.secret
        if secret is None:
            raise ValueError("No credentials secret found on RDS instance")
        return secret.secret_full_arn or secret.secret_arn

    def allow_from(self, security_group: aws_ec2.ISecurityGroup) -> None:
        """Allow inbound PostgreSQL traffic from the given security group."""
        self.security_group.add_ingress_rule(
            security_group,
            aws_ec2.Port.tcp(5432),
            "Allow PostgreSQL access",
        )
