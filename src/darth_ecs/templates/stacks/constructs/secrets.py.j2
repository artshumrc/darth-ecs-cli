"""Secrets Manager integration — generates or imports secrets per environment."""

from __future__ import annotations

import os
from dataclasses import dataclass

from aws_cdk import SecretValue, aws_secretsmanager
from constructs import Construct


class SecretsProvider(Construct):
    """Creates Secrets Manager secrets for a single environment.

    Each ``SecretConfig`` (from the project TOML) becomes one secret entry.
    """

    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        *,
        project_name: str,
        env_name: str,
        secret_configs: list,
    ) -> None:
        super().__init__(scope, construct_id)

        self._secrets: dict[str, aws_secretsmanager.Secret] = {}
        prefix = f"{project_name}-{env_name}"

        for cfg in secret_configs:
            if cfg.source == "generate":
                secret = aws_secretsmanager.Secret(
                    self,
                    f"Secret-{cfg.name}",
                    secret_name=f"{prefix}-{cfg.name.lower().replace('_', '-')}",
                    generate_secret_string=aws_secretsmanager.SecretStringGenerator(
                        password_length=cfg.length,
                        exclude_punctuation=True,
                    ),
                )
            else:
                # Source is "env" — read from deployer's local env var
                env_value = os.environ.get(cfg.name, "")
                if not env_value:
                    raise ValueError(
                        f"Secret '{cfg.name}' source is 'env' but the "
                        f"environment variable is not set"
                    )
                secret = aws_secretsmanager.Secret(
                    self,
                    f"Secret-{cfg.name}",
                    secret_name=f"{prefix}-{cfg.name.lower().replace('_', '-')}",
                    secret_string_value=SecretValue.unsafe_plain_text(env_value),
                )

            self._secrets[cfg.name] = secret

    def get_arns_for(self, names: list[str]) -> dict[str, str]:
        """Return a mapping of secret name → full ARN for the given names."""
        result: dict[str, str] = {}
        for name in names:
            if name in self._secrets:
                sec = self._secrets[name]
                result[name] = sec.secret_full_arn or sec.secret_arn
        return result
